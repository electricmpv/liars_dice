好的，我们来更新这份面向 AI 的产品需求文档，加入基于真实聊天记录和背景信息创建 3 个不同 AI 角色的需求。这会显著影响 AI 的实现方式，特别是模型选择和数据处理部分。

-----

## 产品需求文档：吹牛骰子 AI 角色完整功能 v2.0 (含真实数据定制)

**1. 项目目标**

在现有的多人在线吹牛骰子游戏中，集成**三个**独特的、高度拟人化的 AI 角色。每个 AI 角色的性格、游戏策略、**语言习惯**和**聊天特点**都将基于**特定真人的大量聊天记录、背景信息、生活习惯及爱好**进行定制，旨在提供高度沉浸和个性化的交互体验。

**2. 目标受众**

AI 代码助手 (例如 GitHub Copilot, Cursor, etc.)

**3. 整体架构**

采用**游戏服务器 (`server/`) + 独立 AI 微服务 (`ai-service/`) + AI 模型 (重点：微调) + 数据库**的架构。

  * **游戏服务器:** 同 v1.0，负责核心逻辑、连接、状态同步、通信转发。
  * **AI 微服务 (需新建):** 承载 AI 智能核心。**关键变化：需要能够管理和调用多个**针对不同 Persona 微调后的模型（或使用单个模型配合极强的 Persona Prompt 和 RAG，但微调效果更佳）。处理决策、聊天生成、记忆管理、主动行为。
  * **AI 模型:**
      * **核心方法:** **强烈推荐采用模型微调 (Fine-tuning)**。使用用户提供的真实数据对选定的小型基础模型（如 Llama 3 8B, Phi-3, Gemma 7B 等）进行微调，以**内化**特定人物的语言风格、个性和知识。
      * **备选/过渡:** 在微调完成前，可暂时使用外部 LLM API + 极其详细的 Prompt (包含大量背景、聊天风格示例) + RAG，但这难以完美复现真人的细微习惯和一致性。
  * **数据库 (持久化):** 使用 **Supabase (PostgreSQL)** 存储 AI 与玩家的交互历史、关系数据，以及可能用于 RAG 的 AI 背景知识片段。

**4. AI 角色设定 (Persona) - 需要 3 个**

  * **目标:** 创建 3 个基于不同真人数据源的、具有独特个性、游戏策略和语言风格的 AI 角色。
  * **定义 (为每个 AI 单独定义):**
      * **AI 标识符:** `aiType` (例如: 'persona\_A', 'persona\_B', 'persona\_C') 或唯一的 `aiPlayerId` 前缀。
      * **数据来源:** 明确指出此 AI Persona 基于哪一份用户提供的真人数据包（聊天记录 + 背景描述）。
      * **核心性格特征:** 从背景描述和聊天记录中提炼出的关键性格特点 (例如：风趣幽默、沉稳内敛、急躁好胜等)。
      * **语言习惯:** 总结其独特的用词、口头禅、表情符号使用频率、句子结构、回应风格等（需要从聊天记录分析或用户指定）。
      * **背景与知识:** 生活习惯、爱好、特定知识领域（用于聊天话题和个性化）。
      * **游戏策略:** 定义该 AI 在吹牛骰子游戏中的主要策略风格（例如：胆小鬼/保守型、激进型、平衡型、欺诈型、新手教学型等）。

**5. 数据准备 (关键新增环节)**

  * **输入数据 (用户提供):** 需要为**每个**目标 AI 角色提供一套独立的数据：
    1.  **大量真实聊天记录:** 提供尽可能多的、能代表该人物典型沟通风格的群聊或私聊记录（**注意数据隐私和匿名化处理！**）。记录数量和质量直接影响模仿效果。
    2.  **详细的角色背景描述:** 包括性格分析、生活习惯、兴趣爱好、知识背景、人际关系风格、价值观等。
    3.  **期望的游戏策略描述:** 清晰定义该 AI 在游戏中的行为模式。
  * **数据处理 (需要开发或手动完成):**
      * **聊天记录清洗与格式化:** 将原始聊天记录处理成适合微调的格式。例如，对话轮格式：
        ```json
        {"messages": [{"role": "user", "content": "..." }, {"role": "assistant", "content": "<符合该真人风格的回复>" }]}
        ```
      * **决策数据生成:** 将游戏策略描述和背景信息，结合部分游戏状态示例，生成“指令-输出”格式的决策微调数据（类似之前 PRD 中的例子，但 `output` 要符合该 AI 的策略风格）。可以使用强力 LLM + 人工审核辅助生成。
      * **背景知识结构化:** 将背景、习惯、爱好等信息整理成结构化数据，可能用于微调或 RAG。
  * **给 AI 编辑器的指令:**
      * AI 编码器需**假定**这些处理好的、符合微调要求的数据文件**未来会被提供**。
      * 在 `ai-service` 中可能需要预留加载和使用不同数据集进行微调配置的接口或逻辑框架（如果微调流程也希望 AI 辅助）。
      * RAG 系统需要能有效地从结构化的背景知识和非结构化的聊天记录中检索信息。

**6. 功能需求详解 (基于 v1.0 并扩展)**

**6.1. 核心 Gameplay 集成 (同 v1.0, 但需支持多 AI 类型)**

  * **AI 玩家创建与加入:** `addAIPlayer` 方法需要接受 `aiType` 参数，并据此创建对应名称和行为模式的 AI。服务器需要能管理不同类型的 AI 实例。
  * **AI 游戏决策 (`/decideAction` 接口):**
      * `ai-service` 需要能够根据传入的 `aiPlayerId` 或 `aiType`，**路由到对应的微调模型**进行推理，或者加载对应的 Persona 配置（如果使用单一模型+Prompt）。
      * 决策逻辑不仅要符合游戏规则，还要**严格符合该 AI 类型对应的游戏策略**。

**6.2. 聊天能力 (核心功能)**

  * **目标:** AI 的聊天回复（游戏内、私聊）需要高度**模仿**其对应真人的语言习惯和风格。
  * **实现 (`/generateChat` 接口):**
      * **模型选择:** **优先使用针对该真人聊天记录微调后的模型**进行回复生成。
      * **RAG 强化:** 结合从 Supabase 数据库中检索到的与当前 `humanPlayerId` 的**历史聊天记录**和 AI 的**背景知识/习惯**信息，丰富 Prompt 或上下文，使回复更自然、个性化且符合记忆。
      * **Prompt 设计:** Prompt 需包含指令，要求模型严格按照 Persona 的语言风格和当前上下文进行回复。

**6.3. 记忆系统 (核心功能)**

  * **目标:** 存储所有交互，支撑个性化和 RAG。
  * **实现:** 同 v1.0，使用 Supabase 和 `ai_player_interactions` 表。`storeInteraction` 和 `retrieveInteractions` 函数需要被完整实现并广泛调用。

**6.4. 主动行为 (Phase 2)**

  * **目标:** 基于 AI 的个性和记忆，主动与玩家互动。
  * **实现:** 同 v1.0，但触发条件和发起的交互内容需要与**具体 AI 的性格和记忆**相关联。例如，"风趣型" AI 可能更频繁地主动发起聊天，"好胜型" AI 可能在输掉后主动邀请再来一局。

**6.5. 好感度/关系系统 (可选 Phase 2/3)**

  * **目标:** 模拟关系深度，进一步影响交互。
  * **实现:** 同 v1.0，好感度的增减规则可以根据 AI 的性格和玩家的行为进行定制。

**7. 技术实施细节 (更新)**

  * **AI 服务 (`ai-service`):**
      * **模型管理:** 需要设计如何加载和管理**多个**微调模型（如果每个 AI 类型一个模型）。考虑使用模型服务的框架（如 vLLM, Triton Inference Server, 或简单的进程管理）或者按需加载。如果使用单一模型，则需要管理好不同 Persona 的 Prompt 和配置。
      * **API 路由:** 可能需要调整 API，例如 `/decideAction/{aiType}` 或在请求体中传递 `aiType`。
      * **数据库模块:** 需要完整实现 `storeInteraction` 和 `retrieveInteractions`。
  * **微调流程 (需要额外工具/脚本):**
      * 需要开发或使用现有工具链来处理用户提供的原始数据（聊天记录、背景），将其转换为微调所需的格式。
      * 需要执行模型微调的过程（使用云平台 API、LLaMA Factory 或 Hugging Face `trl` 脚本）。
  * **配置管理:** `.env` 文件需要包含所有 3 个（或更多）AI Persona 可能需要的不同配置（例如，如果它们调用不同的模型 API Endpoint）。

**8. 参考文档**

  * [游戏规则说明：吹牛骰子 v1.1 (供 AI 理解 - 含跳开质疑)](D:\editors\liars_dice_demo\gamerule.md) *(请替换为实际链接或包含其内容)*
  * [各 AI Persona 的详细背景、性格和聊天风格描述文档]() *(需要用户创建)*
  * [微调数据集格式说明]() *(需要定义)*

-----

这个 v2.0 版本的 PRD 更加侧重于**通过真实数据微调模型**来实现高度拟人化的 AI 角色，特别是语言风格的模仿。这对数据准备和模型微调提出了更高的要求，但也是实现你最终目标的关键路径。AI 代码编辑器在阅读此文档后，应优先考虑使用微调模型的技术方案来规划代码实现。